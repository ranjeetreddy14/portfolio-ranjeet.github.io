<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Ranjeet Reddy Manchana" />
  <title>Vehicle Detection and Classification (Upload Video)</title>
  <style>
    :root{ --bg1:#1e1348; --bg2:#2a1766; --grad1:#7b5cff; --grad2:#ff7edb; --grad3:#56c4ff;
           --panel:#1b1642; --border:#3c2f80; --text:#eef; --muted:#b9c0ff;
           --pill:#2a1e66; --accent:#c084fc; --accent2:#93c5fd; --accent3:#f0abfc;
           --light:#56c4ff; --medium:#ffd166; --heavy:#ff6b6b }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:
      radial-gradient(1200px 800px at 15% 10%, var(--grad1), transparent 60%),
      radial-gradient(1000px 700px at 85% 0%, var(--grad2), transparent 55%),
      radial-gradient(1200px 800px at 50% 100%, var(--grad3), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text); font:14px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial }
    a{color:var(--accent2); text-decoration:none}
    a:hover{opacity:.9}

    header{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; position:sticky; top:0; z-index:3; background:rgba(18,10,48,.6); backdrop-filter: blur(8px); border-bottom:1px solid rgba(255,255,255,.08)}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,var(--grad1),var(--grad2)); box-shadow:0 0 20px rgba(124,58,237,.4)}
    h1{margin:0;font-size:16px;letter-spacing:.3px}
    .by{font-size:12px;color:var(--muted); margin-left:8px}
    .actions{display:flex; gap:10px; align-items:center}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:rgba(21,12,66,.6); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#3c2a88,#2a1e66); border-color:#5945c6}

    main{max-width:1180px; margin:22px auto; padding:0 16px; display:grid; grid-template-columns: 360px 1fr; gap:16px}
    @media (max-width:1000px){ main{grid-template-columns:1fr} }

    .card{background:rgba(17,11,54,.6); border:1px solid rgba(255,255,255,.07); border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35)}
    .card .head{padding:14px 14px 0}
    .card .body{padding:14px}
    .card h2{margin:0 0 6px; font-size:14px; color:#e9e8ff}

    .uploader{border:1.5px dashed rgba(255,255,255,.22); background:rgba(18,12,62,.4); border-radius:14px; display:grid; place-items:center; padding:20px; text-align:center}
    .uploader input{display:none}
    .uploader .big{font-size:13px; color:var(--muted)}
    .uploader label{display:inline-flex; gap:8px; align-items:center; margin-top:10px; padding:10px 12px; border-radius:12px; background:linear-gradient(135deg, rgba(123,92,255,.25), rgba(240,171,252,.25)); border:1px solid rgba(255,255,255,.18); cursor:pointer}

    .badge{display:inline-flex; gap:8px; align-items:center; background:rgba(18,12,62,.65); border:1px solid rgba(255,255,255,.14); padding:8px 10px; border-radius:999px; color:#cdd2ff; font-size:12px}

    .viewer{position:relative}
    canvas{width:100%; height:auto; display:block; border-radius:16px}
    .legend{position:absolute; top:10px; left:10px; display:flex; gap:8px; flex-wrap:wrap}
    .chip{display:flex; gap:6px; align-items:center; background:rgba(9,7,35,.6); border:1px solid rgba(255,255,255,.1); padding:6px 10px; border-radius:999px; font-size:12px}
    .dot{width:10px; height:10px; border-radius:50%}

    .stats{display:grid; grid-template-columns: repeat(4, 1fr); gap:8px}
    .kpi{background:rgba(20,15,70,.7); border:1px solid rgba(255,255,255,.1); padding:12px; border-radius:12px; text-align:center}
    .kpi h3{margin:0 0 6px; color:#c6c8ff; font-size:12px}
    .kpi .val{font:800 20px/1 Inter, ui-sans-serif}

   
    .timeline{margin-top:12px}
    #seek{width:100%; appearance:none; height:6px; border-radius:999px; background:linear-gradient(90deg, rgba(123,92,255,.6), rgba(240,171,252,.6)); outline:none}
    #seek::-webkit-slider-thumb{appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; box-shadow:0 0 0 2px #6e59f5}
    .time{display:flex; justify-content:space-between; font-size:12px; color:#cbd0ff; margin-top:6px}

    footer{max-width:1180px; margin:10px auto 40px; padding:0 16px; color:#cfd3ff; font-size:12px; opacity:.9}
    code.inline{background:rgba(17,12,60,.7); border:1px solid rgba(255,255,255,.1); padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <h1>Vehicle Detection and Classification using OpenCV and CNNs</h1>
      <span class="by">by Ranjeet Reddy Manchana</span>
    </div>
    <div class="actions">
      <span id="modelBadge" class="badge">Model: <span id="modelState">loading…</span></span>
      <a id="codeLink" class="btn" href="#" target="_blank" rel="noopener">View Project Code</a>
    </div>
  </header>

  <main>
   
    <section class="card">
      <div class="head"><h2>Upload Video</h2></div>
      <div class="body">
        <div class="uploader" id="dropArea">
          <div>
            <div class="big">Drag & drop a traffic video here</div>
            <label>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 16V4m0 12l-3.5-3.5M12 16l3.5-3.5" stroke="#e8defd" stroke-width="1.6" stroke-linecap="round"/><rect x="3" y="16" width="18" height="5" rx="2" stroke="#e8defd" stroke-width="1.6"/></svg>
              <span>Browse video</span>
              <input id="videoFile" type="file" accept="video/*" />
            </label>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:14px">
          <button id="startBtn" class="btn primary">Start</button>
          <button id="pauseBtn" class="btn">Pause</button>
          <button id="resetBtn" class="btn">Reset Counts</button>
        </div>
        <div class="timeline">
          <input id="seek" type="range" min="0" max="0" step="0.01" value="0" />
          <div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
        </div>
        <div id="statusMsg" style="margin-top:10px; color:#cbd0ff; font-size:12px">Please upload video input.</div>
      </div>
    </section>


    <section class="card viewer">
      <div class="body" style="position:relative">
        <div class="legend">
          <span class="chip"><span class="dot" style="background:var(--light)"></span> Light</span>
          <span class="chip"><span class="dot" style="background:var(--medium)"></span> Medium</span>
          <span class="chip"><span class="dot" style="background:var(--heavy)"></span> Heavy</span>
        </div>
        <canvas id="out" width="1280" height="720"></canvas>
      </div>
      <div class="body">
        <h2>Counts</h2>
        <div class="stats">
          <div class="kpi"><h3>Total</h3><div id="kTotal" class="val">0</div></div>
          <div class="kpi"><h3>Light</h3><div id="kLight" class="val">0</div></div>
          <div class="kpi"><h3>Medium</h3><div id="kMedium" class="val">0</div></div>
          <div class="kpi"><h3>Heavy</h3><div id="kHeavy" class="val">0</div></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2025 Ranjeet Reddy Manchana. Built with <code class="inline">onnxruntime-web</code> and <code class="inline">OpenCV.js</code>. All inference happens client-side. Replace <code class="inline">DEFAULT_MODEL_URL</code> and <code class="inline">CODE_LINK</code> with your GitHub links.</p>
  </footer>

  <!-- Libraries -->
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <script>

  const DEFAULT_MODEL_URL = './models/yolov5s.onnx';
  const CODE_LINK = 'https://github.com/ranjeetreddy14/ranjeetreddy14.github.io/tree/main/projects/vehicle-counter';

  document.getElementById('codeLink').href = CODE_LINK;

  // DOM and state
  const canvas = document.getElementById('out');
  const ctx = canvas.getContext('2d');
  const video = document.createElement('video');
  video.playsInline = true; video.muted = true; video.autoplay = false; // we manage play/pause
  const fileInput = document.getElementById('videoFile');
  const dropArea = document.getElementById('dropArea');
  const modelState = document.getElementById('modelState');
  const statusMsg = document.getElementById('statusMsg');
  const seek = document.getElementById('seek');
  const curEl = document.getElementById('cur');
  const durEl = document.getElementById('dur');

  const COUNTS = { light:0, medium:0, heavy:0, total:0 };
  const kTotal=document.getElementById('kTotal'), kLight=document.getElementById('kLight'), kMedium=document.getElementById('kMedium'), kHeavy=document.getElementById('kHeavy');
  const setKpis=()=>{ kTotal.textContent=COUNTS.total; kLight.textContent=COUNTS.light; kMedium.textContent=COUNTS.medium; kHeavy.textContent=COUNTS.heavy; };

  const COCO=['person','bicycle','car','motorcycle','airplane','bus','train','truck','boat','traffic light','fire hydrant','stop sign','parking meter','bench','bird','cat','dog','horse','sheep','cow','elephant','bear','zebra','giraffe','backpack','umbrella','handbag','tie','suitcase','frisbee','skis','snowboard','sports ball','kite','baseball bat','baseball glove','skateboard','surfboard','tennis racket','bottle','wine glass','cup','fork','knife','spoon','bowl','banana','apple','sandwich','orange','broccoli','carrot','hot dog','pizza','donut','cake','chair','couch','potted plant','bed','dining table','toilet','tv','laptop','mouse','remote','keyboard','cell phone','microwave','oven','toaster','sink','refrigerator','book','clock','vase','scissors','teddy bear','hair drier','toothbrush'];
  const VEHICLES=new Set([1,2,3,5,7]);

  const state={ session:null, running:false, inputSize:640, conf:0.35, iou:0.45, lineY:0.60, tracker:null, crossed:new Set(), videoReady:false };

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const fmt=t=>{ t=Math.max(t,0); const m=Math.floor(t/60), s=Math.floor(t%60); return m+':' + (s<10?'0'+s:s); };
  let lastVideoTime=0;

  async function waitForOpenCV(){ if(window.cv && window.cv.Mat) return; await new Promise(res=>{ const id=setInterval(()=>{ if(window.cv && window.cv.Mat){ clearInterval(id); res(); } },30); }); }

  class Tracker{ constructor(){ this.nextId=1; this.tracks=new Map(); }
    update(dets){ const updated=new Map(), used=new Set(); for(const [id,t] of this.tracks){ t.ttl=(t.ttl||10)-1; }
      for(const d of dets){ let best=null, biou=0, bdist=1e9; for(const [id,t] of this.tracks){ if(used.has(id)) continue; const iou=boxIoU(t.bbox,d.bbox), dist=centroidDist(t.bbox,d.bbox); if((iou>0.1)||(dist<80)){ if(iou>biou||(Math.abs(iou-biou)<1e-6&&dist<bdist)){ biou=iou; bdist=dist; best=id; } } }
        if(best){ const t=this.tracks.get(best); t.bbox=d.bbox; t.cls=d.cls; t.bucket=d.bucket; t.score=d.score; t.ttl=10; t.lastCentroid=boxCentroid(d.bbox); updated.set(best,t); used.add(best); }
        else { const id=this.nextId++; const t={id, bbox:d.bbox, cls:d.cls, bucket:d.bucket, score:d.score, ttl:10, lastCentroid:boxCentroid(d.bbox), lastSide:null}; updated.set(id,t); used.add(id); }
      }
      for(const [id,t] of this.tracks){ if(!used.has(id) && t.ttl>0) updated.set(id,t); }
      this.tracks=updated; return Array.from(this.tracks.values()); }
  }
  function boxIoU(a,b){const x1=Math.max(a[0],b[0]), y1=Math.max(a[1],b[1]), x2=Math.min(a[2],b[2]), y2=Math.min(a[3],b[3]); const w=Math.max(0,x2-x1), h=Math.max(0,y2-y1); const inter=w*h; const ua=(a[2]-a[0])*(a[3]-a[1])+(b[2]-b[0])*(b[3]-b[1])-inter; return ua>0? inter/ua:0; }
  function boxCentroid(b){return[(b[0]+b[2])/2,(b[1]+b[3])/2]}
  function centroidDist(a,b){const ca=boxCentroid(a), cb=boxCentroid(b); return Math.hypot(ca[0]-cb[0], ca[1]-cb[1]);}
  function nms(boxes, scores, thr){const idx=boxes.map((_,i)=>i).sort((i,j)=>scores[j]-scores[i]); const keep=[]; while(idx.length){const i=idx.shift(); keep.push(i); for(let k=idx.length-1;k>=0;k--){ if(boxIoU(boxes[i], boxes[idx[k]])>thr) idx.splice(k,1); } } return keep; }

  function bucketFor(clsName, box, frameArea){ const area=(box[2]-box[0])*(box[3]-box[1]); const r=area/frameArea; switch(clsName){ case 'bus': return 'heavy'; case 'truck': return r>0.04?'heavy':'medium'; case 'car': return r>0.025?'medium':'light'; case 'motorcycle': case 'bicycle': return 'light'; default: return 'light'; } }
  function drawBox(b, color, text){ ctx.strokeStyle=color; ctx.lineWidth=2; ctx.strokeRect(b[0],b[1],b[2]-b[0],b[3]-b[1]); if(text){ ctx.font='12px Inter, system-ui'; ctx.fillStyle='rgba(16,12,64,.75)'; const w=ctx.measureText(text).width+10; ctx.fillRect(b[0]-1,b[1]-18,w,18); ctx.strokeStyle=color; ctx.strokeRect(b[0]-1,b[1]-18,w,18); ctx.fillStyle='#eef'; ctx.fillText(text,b[0]+4,b[1]-5); } }

  // Preprocess and scale helpers (RGB CHW; matches your working export)
  function preprocess(mat, input){ const rgb=new cv.Mat(); cv.cvtColor(mat, rgb, cv.COLOR_RGBA2RGB); const ratio=Math.min(input/mat.cols, input/mat.rows); const nw=Math.round(mat.cols*ratio), nh=Math.round(mat.rows*ratio); const resized=new cv.Mat(); cv.resize(rgb, resized, new cv.Size(nw,nh),0,0,cv.INTER_LINEAR); const framed=new cv.Mat(); framed.create(input,input, cv.CV_8UC3); framed.setTo(new cv.Scalar(114,114,114)); const x=Math.floor((input-nw)/2), y=Math.floor((input-nh)/2); const roi=framed.roi(new cv.Rect(x,y,nw,nh)); resized.copyTo(roi); roi.delete(); const data=new Float32Array(3*input*input); let i=0; for(let c=0;c<3;c++){ for(let y0=0;y0<input;y0++){ for(let x0=0;x0<input;x0++){ data[i++]=framed.ucharPtr(y0,x0)[c]/255; } } } rgb.delete(); resized.delete(); framed.delete(); return { tensor:new ort.Tensor('float32', data, [1,3,input,input]), ratio, padX:x, padY:y } }
  function projectBox(b, ratio, padX, padY, W,H){ let x1=(b[0]-padX)/ratio, y1=(b[1]-padY)/ratio, x2=(b[2]-padX)/ratio, y2=(b[3]-padY)/ratio; x1=clamp(x1,0,W); y1=clamp(y1,0,H); x2=clamp(x2,0,W); y2=clamp(y2,0,H); return [x1,y1,x2,y2]; }

  // Decoder for (1, N, 85)
  function decodeYolo(out, conf){ const data=out.data, shape=out.dims; const res=[]; if(!shape || shape.length!==3 || shape[2]!==85) return res; const N=shape[1], S=85; for(let i=0;i<N;i++){ const base=i*S; const bx=data[base], by=data[base+1], bw=data[base+2], bh=data[base+3]; const obj=data[base+4]; let best=-1, bestSc=0; for(let c=5;c<S;c++){ const sc=data[base+c]; if(sc>bestSc){ bestSc=sc; best=c-5; } } const score=obj*bestSc; if(score<conf) continue; const x1=bx-bw/2, y1=by-bh/2, x2=bx+bw/2, y2=by+bh/2; res.push({xyxy:[x1,y1,x2,y2], cls:best, score}); } return res; }

  // Load model
  async function loadModel(url){ try{ modelState.textContent='loading…'; state.session = await ort.InferenceSession.create(url, { executionProviders:['wasm'], graphOptimizationLevel:'all' }); state.tracker=new Tracker(); modelState.textContent='loaded'; }catch(e){ console.error(e); modelState.textContent='failed'; alert('Failed to load model. Check DEFAULT_MODEL_URL or CORS.'); } }

  function setCanvasFromVideo(){ const ar=video.videoWidth/video.videoHeight; const W=1280, H=Math.round(W/ar); canvas.width=W; canvas.height=H; }

  // Drag & drop
  ;['dragenter','dragover','dragleave','drop'].forEach(evt=> dropArea.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); }));
  ;['dragenter','dragover'].forEach(evt=> dropArea.addEventListener(evt, ()=> dropArea.style.borderColor='rgba(255,255,255,.45)'));
  ;['dragleave','drop'].forEach(evt=> dropArea.addEventListener(evt, ()=> dropArea.style.borderColor='rgba(255,255,255,.22)'));
  dropArea.addEventListener('drop', e=>{ const f=e.dataTransfer.files[0]; if(f) handleVideoFile(f); });
  fileInput.addEventListener('change', e=>{ const f=e.target.files[0]; if(f) handleVideoFile(f); });

  async function handleVideoFile(f){ if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    statusMsg.textContent='Loading video…';
    video.src = URL.createObjectURL(f);
    video.onloadedmetadata = ()=>{ state.videoReady=true; setCanvasFromVideo(); seek.max = video.duration.toFixed(2); seek.value = 0; curEl.textContent='0:00'; durEl.textContent = fmt(video.duration); lastVideoTime = 0; resetAllCounts(false); statusMsg.textContent = `Selected: ${f.name}`; };
    video.load();
  }

  // Buttons
  document.getElementById('startBtn').addEventListener('click', async ()=>{ if(!state.session){ alert('Model not loaded yet.'); return;} if(!state.videoReady){ alert('Upload a video first.'); return;} await waitForOpenCV(); try{ await video.play(); }catch(_){} state.running=true; requestAnimationFrame(loop); });
  document.getElementById('pauseBtn').addEventListener('click', ()=>{ state.running=false; video.pause(); });
  document.getElementById('resetBtn').addEventListener('click', ()=> resetAllCounts(true));

  // Seekbar interactions + rewind detection
  seek.addEventListener('input', ()=>{ if(!state.videoReady) return; const t=parseFloat(seek.value||'0'); const rew = t < (lastVideoTime - 0.05); video.currentTime = t; if (rew) resetAllCounts(true); });

  video.addEventListener('timeupdate', ()=>{ if(!isFinite(video.duration)) return; seek.value = (video.currentTime||0).toFixed(2); curEl.textContent = fmt(video.currentTime||0); if ((video.currentTime||0) + 0.05 < lastVideoTime) { resetAllCounts(true); } lastVideoTime = video.currentTime||0; });

  function resetAllCounts(showMsg){ COUNTS.light=COUNTS.medium=COUNTS.heavy=COUNTS.total=0; state.crossed.clear(); if(state.tracker && state.tracker.tracks) state.tracker.tracks.clear(); setKpis(); if(showMsg) statusMsg.textContent='Counter reset (seek/rewind).'; }

  // Core loop
  async function loop(){ if(!state.running) return; const W=canvas.width, H=canvas.height; const frameArea=W*H; ctx.drawImage(video,0,0,W,H); const imgData=ctx.getImageData(0,0,W,H); const mat=cv.matFromImageData(imgData);
    const {tensor, ratio, padX, padY}=preprocess(mat, state.inputSize); const name=state.session.inputNames[0]; const feeds={ [name]:tensor }; const outMap=await state.session.run(feeds); const out=outMap[state.session.outputNames[0]]; let dets=decodeYolo(out, state.conf); const boxes=[], scores=[], kept=[]; for(const d of dets){ if(!VEHICLES.has(d.cls)) continue; boxes.push(d.xyxy); scores.push(d.score); kept.push(d); }
    const keep=nms(boxes, scores, state.iou); const final=keep.map(i=>kept[i]); const projected=final.map(d=>{ const b=projectBox(d.xyxy, ratio, padX, padY, W, H); const clsName=COCO[d.cls]||'obj'; const bucket=bucketFor(clsName,b,frameArea); return {bbox:b, cls:d.cls, clsName, score:d.score, bucket}; });
    if(!state.tracker) state.tracker=new Tracker(); const tracks=state.tracker.update(projected);
    const y=H*state.lineY; ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.setLineDash([8,6]); ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); ctx.setLineDash([]);
    for(const tr of tracks){ const b=tr.bbox; const c=boxCentroid(b); const above=c[1] < y; if(tr.lastSide==null) tr.lastSide=above; if(tr.lastSide!==above){ if(!state.crossed.has(tr.id)){ state.crossed.add(tr.id); COUNTS[tr.bucket]++; COUNTS.total++; setKpis(); } tr.lastSide=above; } }
    for(const tr of tracks){ let color='#56c4ff'; if(tr.bucket==='medium') color='#ffd166'; if(tr.bucket==='heavy') color='#ff6b6b'; const label=`${tr.clsName} ${Math.round((tr.score||0)*100)}% • ${tr.bucket}`; drawBox(tr.bbox,color,label); }
    mat.delete(); requestAnimationFrame(loop);
  }

  // Init
  window.addEventListener('load', ()=>{ loadModel(DEFAULT_MODEL_URL); });

  // Cleanup
  window.addEventListener('beforeunload', ()=>{ if(video && video.srcObject){ try{ video.srcObject.getTracks().forEach(t=>t.stop()); }catch(e){} } });
  </script>
</body>
</html>
